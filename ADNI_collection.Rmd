---
title: "ADNI_collection"
author: "Xinyu Guo"
date: "4/29/2021"
output: html_document
---

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(skimr)
library(vistime)
library(kableExtra)
```

## Key merged data
```{r}
loc <- "/Users/xinyuguo/OneDrive - Johns Hopkins/AD Biomarker/AD_Tools/ADTool/ADNI_data/smry"
# files <- list.files(loc, pattern = ".csv", full.names = T)
# dicts <- files[grep("dict", files, ignore.case = T)]
# datas <- files[-grep("dict", files, ignore.case = T)]
key_data <- read.csv(paste0(loc, "/ADNIMERGE.csv"), header = T)
info_ids <- key_data %>% 
  select(RID, COLPROT, ORIGPROT) %>% 
  unique()
skim(key_data)
```

## Cohort Summary

### PARTICIPANT STAGES: 

- CN – NORMAL AGING/COGNITIVELY NORMAL
- SMC – SIGNIFICANT MEMORY CONCERN
- EMCI – Early Mild Cognitive Impairment
- MCI – Mild Cognitive Impairment
- LMCI – Late Mild Cognitive Impairment

### ADNI1 

#### PARTICIPANT POOL:

* 200 Normal Controls
* 400 MCI
* 200 Mild AD

#### OBJECTIVES:

1. Develop improved methods that create uniform standards for acquiring longitudinal, multi-site MRI and PET data on patients with Alzheimer’s disease (AD), mild cognitive impairment (MCI), and elderly controls.
2. Acquire a generally accessible data repository which describes longitudinal changes in brain structure and metabolism as well as clinical/cognitive and biomarker data for the validation of imaging surrogates.
3. Develop methods which will provide maximum power to determine treatment effects in trials involving these patients.
4. Test a series of hypotheses based on the clinical and biomarker data.

### ADNI GO

#### PARTICIPANT POOL:

* 200 EMCI (new)
* 500 Normal Controls and MCI (rollover from ADNI1)

#### OBJECTIVES:

1. Define and characterize the stage of the AD spectrum that precedes MCI by enrolling 200 subjects in the mildest symptomatic phase of AD (EMCI).
2. Perform F18 amyloid imaging on the CN and LMCI subjects from ADNI1 and the newly enrolled EMCI subjects. FDG PET will be performed in association with F18 amyloid imaging.
3. Establish a national network for F18 amyloid imaging and test hypotheses concerning the prevalence and severity of brain amyloid accumulation and its relationship to current and previous changes of clinical state, MRI, FDG-PET, CSF and plasma biomarkers from ADNI1.
4. Collect 3T MRI on all newly enrolled subjects at Baseline, Month 3, Month 6, and Month 12.
5. Continue longitudinal clinical/cognitive and 1.5T MRI studies of approximately 500 LMCI and Cognitively Normal subjects from ADNI1 for an additional 2 years.
6. Collect and analyze blood and CSF biomarkers from all newly enrolled EMCI and follow-up subjects.
7. Collect blood samples for DNA and RNA extraction. Newly enrolled subjects will also have samples collected for Cell Immortalization and APOE genotyping.

### ADNI2

#### PARTICIPANT POOL:

* 150 Normal Controls (new)
* 450-500 CN and MCI (rollover from ADNI1; approximate)
* 150 EMCI (new)
* 200 EMCI (rollover from ADNI GO; approximate)
* 150 LMCI (new)
* 200 mild AD (new)

#### OBJECTIVES:

1. Determine the relationships among clinical, imaging, genetic, and biochemical biomarker characteristics of the entire spectrum of Alzheimer’s disease (AD) as the pathology evolves.
2. Inform the neuroscience of AD, identify diagnostic and prognostic markers and outcome measures that can be used in clinical trials, and help develop the most effective clinical trial scenarios.
3. Develop uniform standards for acquiring longitudinal multisite MRI and PET data on patients with AD, MCI, and elderly controls.
4. Perform longitudinal clinical, cognitive, MRI, PET (18F-Florbetapir and FDG), and blood and CSF biomarker studies on 550 newly enrolled subjects in addition to continuing these studies for approximately 700 subjects from ADNI1 and ADNI GO for an additional 5 years.
5. Collect blood samples for DNA and RNA extraction. Newly enrolled subjects will also have samples collected for Cell Immortalization and APOE genotyping.
6. Validate the clinical diagnoses and imaging and biomarker surrogates through neuropathological examination of ADNI1, ADNI GO, and ADNI2 participants who come to autopsy.

### ADNI3

#### PARTICIPANT POOL:

* 135-500 Normal Controls (new)
* 295-330 Normal Controls (rollover from ADNI2; approximate)
* 150-515 Mild Cognitive Impairment (MCI) (new)
* 275-320 Mild Cognitive Impairment (MCI) (rollover from ADNI2; approximate)
* 85-185 Mild Alzheimer’s Disease dementia (AD) (new)
* 130-150 Mild Alzheimer’s Disease dementia (AD) (rollover from ADNI2; approximate)

#### OBJECTIVES:

1. *Longitudinal changes in cognition and associated biomarkers*: 
Determine and define those measures of cognition and function, including composite measures, and those biomarker measures, which capture longitudinal change with the highest statistical power to detect treatment effects in clinical trials. Longitudinal change of cerebral tau measured with 18F-AV-1451 PET (AV-1451) will be correlated/compared with other measures.

2. *Prediction of cognitive decline*: 
Determine which clinical, cognitive, and biomarker measures that best predict decline of cognition in CN, MCI, and AD participants. In addition, determine which biomarker changes correlate with cognitive decline, with focus on AV-1451 PET.

3. *Validation*: 
Validate biomarker measures obtained at Baseline and longitudinally by correlating results with ‘gold standard’ clinical measurements and pathology.

4. *Clinical trial design*: 
Determine the optimum outcome measures with attention to cognitive decline and AV-1451 PET (tau PET) , predictors of cognitive decline, and inclusion/exclusion criteria for clinical trials of cognitively normal participants (for secondary preclinical AD trials), MCI patients (for prodromal AD trials) and participants with early dementia due to AD.

5. *Discovery*: 
To determine the effects of other known disease proteins found in AD brains and genes, as well as newly discovered genes, proteins, and analytes that provide useful information concerning the pathogenesis/diagnosis of AD.

```{r}
data_cohort <- key_data %>%
  select(RID, VISCODE, COLPROT, ORIGPROT, DX_bl, DX, EXAMDATE_bl, EXAMDATE) 
# ADNI1
smry_adni1 <- data_cohort %>% 
  filter(ORIGPROT == "ADNI1") %>% # all ORIGPROT are the same as COLPROT
  select(RID, DX_bl) %>% 
  unique()
table(smry_adni1$DX_bl)
```

The key data does not contain "all" patients

```{r}
loc <- "/Users/xinyuguo/OneDrive - Johns Hopkins/AD Biomarker/AD_Tools/ADTool/ADNI_data/smry"
data_rgstr <- read.csv(paste0(loc, "/REGISTRY.csv")) %>% 
  select(Phase, RID, VISCODE, USERDATE, USERDATE2) %>% 
  arrange(RID)
data_patients <- data_rgstr %>% 
  left_join(data_cohort, by = c("RID", "VISCODE"))
kbl(head(data_patients, 60)) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

```{r}
loc <- "/Users/xinyuguo/OneDrive - Johns Hopkins/AD Biomarker/AD_Tools/ADTool/ADNI_data/CSF"
files <- list.files(loc, pattern = ".csv", full.names = T)
dicts <- files[grep("dict", files, ignore.case = T)]
datas <- files[-grep("dict", files, ignore.case = T)]
list_data <- c()
for (tbl in datas) {
  tem_data <- read.csv(tbl, header = T)
  name_data <- gsub(".csv", "", basename(tbl))
  assign(name_data, tem_data)
  list_data <- c(list_data, name_data)
}
cat(list_data)
for (dt in list_data) {
  rcd <- info_ids %>% 
    filter(RID %in% unique(get(dt)$RID))
  cat(dt, ":\n")
  print(table(rcd %>% 
                select(-RID)))
  cat("Length:", length(unique(get(dt)$RID)), '\n')
}
skim(UPENNBIOMK_MASTER)
head(UPENNBIOMK_MASTER)
UPENNBIOMK_MASTER_ptt <- data_patients %>% 
  select(-c("USERDATE", "USERDATE2")) %>% 
  left_join(UPENNBIOMK_MASTER, by = c("RID", "VISCODE"))
head(UPENNBIOMK_MASTER_ptt)

skim(UPENNBIOMK10_07_29_19)
UPENNBIOMK10_07_29_19_ptt <- data_patients %>% 
  select(-c("USERDATE", "USERDATE2")) %>% 
  left_join(UPENNBIOMK10_07_29_19, by = c("RID", "VISCODE"))
head(UPENNBIOMK10_07_29_19_ptt)

skim(UPENNBIOMK12_01_04_21)
UPENNBIOMK12_01_04_21_ptt <- data_patients %>% 
  select(-c("USERDATE", "USERDATE2")) %>% 
  left_join(UPENNBIOMK12_01_04_21, by = c("RID", "VISCODE"))
head(UPENNBIOMK12_01_04_21_ptt)

skim(UPENNBIOMK9_04_19_17)
UPENNBIOMK9_04_19_17_ptt <- data_patients %>% 
  select(-c("USERDATE", "USERDATE2")) %>% 
  left_join(UPENNBIOMK9_04_19_17, by = c("RID", "VISCODE"))
head(UPENNBIOMK9_04_19_17_ptt)

skim(UPENNBIOMKADNIDIAN2017)
UPENNBIOMKADNIDIAN2017_ptt <- data_patients %>% 
  select(-c("USERDATE", "USERDATE2")) %>% 
  left_join(UPENNBIOMKADNIDIAN2017, by = c("RID", "VISCODE"))
head(UPENNBIOMKADNIDIAN2017_ptt)
```

```{r}
vistime(UPENNBIOMK_MASTER[1:30, ] %>% mutate(start = DRWDTE, end = RUNDATE, group = RID, event = DRWDTE))
vistime(UPENNBIOMK10_07_29_19[1:30, ] %>% mutate(start = DRAWDATE, end = RUNDATE, group = RID, event = DRAWDATE))
vistime(UPENNBIOMK12_01_04_21[1:30, ] %>% mutate(start = EXAMDATE, end = RUNDATE, group = RID, event = EXAMDATE))
vistime(UPENNBIOMK9_04_19_17[1:30, ] %>% mutate(start = EXAMDATE, end = RUNDATE, group = RID, event = EXAMDATE))
vistime(UPENNBIOMKADNIDIAN2017[1:30, ] %>% mutate(start = EXAMDATE, end = RUNDATE, group = RID, event = EXAMDATE))
```

```{r}
id <- key_data %>% select(RID)
scf_all <- id %>% 
  left_join(UPENNBIOMK_MASTER, by = "RID") %>% 
  left_join(UPENNBIOMK10_07_29_19, by = "RID") %>% 
  left_join(UPENNBIOMK12_01_04_21, by = "RID") %>% 
  left_join(UPENNBIOMK9_04_19_17, by = "RID") %>% 
  left_join(UPENNBIOMKADNIDIAN2017, by = "RID")
```

## Merge all data
```{r}
adni_all <- merged_data %>% 
  left_join(adni_csf, by = c("RID", "VISCODE"), suffix = c("", "_scf")) %>% 
  left_join(adni_cog, by = c("RID", "VISCODE"), suffix = c("", "_cog")) %>% 
  left_join(merged_data, by = c("RID", "VISCODE"), suffix = c("", "_merged")) %>% 
  left_join(adni_img_mri, by = c("RID", "VISCODE"), suffix = c("", "_img_mri")) %>% 
  left_join(adni_img_pet, by = c("RID", "VISCODE"), suffix = c("", "_img_pet"))

write.csv(adni_all, "~/Desktop/adni_all.csv")
```

## Merge all variables
```{r}
vars_all <- rbind(vars_apoe, vars_cog, vars_csf, vars_demo, vars_diag, vars_imaging)
head(vars_all)
```

















